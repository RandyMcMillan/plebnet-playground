#!/bin/bash

BITCOIN_CLI=$(which bitcoin-cli)
export BITCOIN_CLI
mkdir -p /tmp/blocknotify
LOG_DIR=/tmp/blocknotify

PLAY_BITCOIN_ADDRESS=$(play-bitcoin getnewaddress) > /dev/null 2>&1
export PLAY_BITCOIN_ADDRESS

PLAY_LND_ADDRESS=$(play-lnd newaddress) > /dev/null 2>&1
export PLAY_LND_ADDRESS

$BITCOIN_CLI -signet createwallet playground-wallet > /dev/null 2>&1
$BITCOIN_CLI -signet -rpcwallet=playground-wallet settxfee 0.0$k > /dev/null 2>&1

get-coins(){

if [ ! -z "$BITCOIN_CLI" ]; then
    play-getcoins -a $($BITCOIN_CLI -signet -rpcwallet=playground-wallet getnewaddress) -r false > /dev/null 2>&1
fi

play-getcoins -a $PLAY_BITCOIN_ADDRESS -r true > /dev/null 2>&1
play-getcoins -a $PLAY_LND_ADDRESS     -r true > /dev/null 2>&1

}

init(){

    echo init
    echo $k

if [ ! -z "$BITCOIN_CLI" ]; then
    $BITCOIN_CLI -signet -rpcwallet=playground-wallet sendtoaddress \
        $($BITCOIN_CLI -signet -rpcwallet=playground-wallet getnewaddress) 0.$k \
        -fallbackfee=0.0$k #> /dev/null 2>&1
    
    $BITCOIN_CLI -signet -rpcwallet=playground-wallet sendtoaddress \
        $(play-getcoins -r true) 0.$k \
        -fallbackfee=0.0$k #> /dev/null 2>&1
fi
    #if [[ ! -z "$BITCOIN_CLI" ]]; then
    #    $(bitcoin-cli createwallet playground-wallet > /dev/null 2>&1)
    #    SELF_ADDRESS=$(bitcoin-cli -signet -rpcwallet=playground-wallet getnewaddress)
    #    export SELF_ADDRESS
    #fi
    
    PLAY_BITCOIN_ADDRESS=$(play-bitcoin getnewaddress)
    export PLAY_BITCOIN_ADDRESS

}

func2(){

    echo func2
    echo $k

    PLAY_BITCOIN_ADDRESS=$(play-bitcoin getnewaddress)
    export PLAY_BITCOIN_ADDRESS

if [ ! -z "$BITCOIN_CLI" ]; then
    echo "{ \"settxfee 0.00$k\": \"$(bitcoin-cli -signet -rpcwallet=playground-wallet settxfee 0.0$k)\" }," > /dev/null 2>&1
    $(bitcoin-cli -signet  -rpcwallet=playground-wallet sendtoaddress "$PLAY_BITCOIN_ADDRESS"  0.0$k -fallbackfee=$k ) > /dev/null 2>&1
    #$(bitcoin-cli -signet  -rpcwallet=playground-wallet -named sendtoaddress address="$PLAY_BITCOIN_ADDRESS" amount=0.00$k fee_rate=$k comment=$TIME-$k ) > /dev/null 2>&1
    $(bitcoin-cli -named sendtoaddress address="$PLAY_BITCOIN_ADDRESS" amount=$k$i$j fee_rate=$k$i$j subtractfeefromamount=false replaceable=true avoid_reuse=true comment="2 pizzas" comment_to="jeremy")
fi

}
play-bitcoin-sendtoaddress(){

    echo play-bitcoin-sendtoaddress
    echo $k

    PLAY_BITCOIN_ADDRESS=$(play-bitcoin getnewaddress)
    export PLAY_BITCOIN_ADDRESS
    play-bitcoin sendtoaddress playground-wallet $PLAY_BITCOIN_ADDRESS 0.01$k0001 #-fallbackfee=$k00001
    play-bitcoin sendtoaddress playground-wallet $PLAY_BITCOIN_ADDRESS 0.01$k001  #-fallbackfee=$k0001
    play-bitcoin sendtoaddress playground-wallet $PLAY_BITCOIN_ADDRESS 0.01$k01   #-fallbackfee=$k001
    play-bitcoin sendtoaddress playground-wallet $PLAY_BITCOIN_ADDRESS 0.01$k1    #-fallbackfee=$k01

}

end_time(){

    echo "{ \"END_TIME\": $(date +%s) }]}"

}
################################################################################
main(){

    #echo main

    for (( i = 0; i <= 9; i++ ))    ### i loop
    do
        export i
        for (( j = 1 ; j <= 8; j++ )) ### j loop
        do
            export j
                padtowidth=$j
                #for z in 0 {1..10} {11..20}; do
                for z in 0 {1..9}; do
                    k=$(printf "%0*d\n" $padtowidth $z;)
                    export k
                    play-bitcoin getbalances
                    play-lnd walletbalance
                    echo $i $j $k
                    get-coins
                    play-bitcoin getbalances
                    play-lnd walletbalance
                    echo $i $j $k
                    init
                    play-bitcoin getbalances
                    play-lnd walletbalance
                    echo $i $j $k
                    func2
                    play-bitcoin getbalances
                    play-lnd walletbalance
                    echo $i $j $k
                    play-bitcoin-sendtoaddress
                    play-bitcoin getbalances
                    play-lnd walletbalance
                    echo $i $j $k
                    sleep 0.001 #$k
                done
       done
   done

}
main

blocknotify
#